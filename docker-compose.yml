services:
  # Redis特征缓存服务
  redis:
    image: redis:7.2-alpine
    container_name: image-trace-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - image-trace-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Redis管理界面
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: image-trace-redis-commander
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379:0:redis123
    depends_on:
      - redis
    networks:
      - image-trace-network
    restart: unless-stopped

  # MinIO对象存储服务 (使用指定SHA256版本以确保稳定性)
  # 注意: 当前版本使用AGPLv3许可证，商用请购买授权
  minio:
    image: minio/minio@sha256:a1ea29fa28355559ef137d71fc570e508a214ec84ff8083e39bc5428980b015e
    container_name: image-trace-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - image-trace-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO客户端（用于创建存储桶）- 暂时禁用
  # minio-client:
  #   image: minio/mc:latest
  #   container_name: image-trace-minio-client
  #   entrypoint: >
  #     /bin/sh -c "
  #     /usr/bin/mc alias set myminio http://minio:9000 minioadmin minioadmin123 &&
  #     /usr/bin/mc mb myminio/image-trace-uploads ||
  #     echo 'Bucket image-trace-uploads already exists' &&
  #     /usr/bin/mc mb myminio/image-trace-extracted ||
  #     echo 'Bucket image-trace-extracted already exists' &&
  #     /usr/bin/mc mb myminio/image-trace-documents ||
  #     echo 'Bucket image-trace-documents already exists' &&
  #     /usr/bin/mc anonymous set public myminio/image-trace-uploads &&
  #     /usr/bin/mc anonymous set public myminio/image-trace-extracted &&
  #     /usr/bin/mc anonymous set public myminio/image-trace-documents &&
  #     echo 'MinIO setup complete'
  #     "
  #   depends_on:
  #     - minio
  #   networks:
  #     - image-trace-network
  #   restart: "no"

volumes:
  # Redis数据
  redis_data:
    driver: local

  # MinIO数据
  minio_data:
    driver: local

networks:
  image-trace-network:
    driver: bridge