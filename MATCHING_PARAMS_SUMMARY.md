# 图像匹配参数配置总结

## 快速参考表

| 参数类型 | 截图模式 | 常规模式 | 说明 |
|---------|---------|---------|------|
| **尺度范围** | 0.1x - 10x | 0.4x - 2.5x | 支持的缩放倍数 |
| **尺度采样点** | 11个 | 7个 | 多尺度特征提取的采样数 |
| **特征点/尺度** | 1500 | 1000 | 每个尺度提取的特征点数 |
| **总特征点** | ~16,500 | ~7,000 | 理论最大特征点数 |
| **Ratio阈值** | 0.85 | 0.75 | Lowe's ratio test阈值 |
| **RANSAC阈值** | 15.0 | 8.0 | 几何验证容忍度（像素） |
| **最小匹配数** | 3 | 4 | 接受匹配的最少点数 |
| **最小内点数** | 2 | 3 | RANSAC内点要求 |
| **匹配保留率** | 70% | 50% | 保留good matches的比例 |
| **相似度奖励** | 8%/点 | 0% | 每个额外匹配点的奖励 |

## 截图模式触发条件

满足以下**任一**条件即自动启用截图模式：

1. ✅ 图像面积比 > **1.3倍**
2. ✅ 宽度比例 > **1.5倍**
3. ✅ 高度比例 > **1.5倍**
4. ✅ 传统截图检测（屏幕分辨率、宽高比等）

## 尺度采样点详细分布

### 截图模式（11个尺度）

```
0.1x  ──→  10倍缩小
0.2x  ──→  5倍缩小
0.35x ──→  约3倍缩小
0.5x  ──→  2倍缩小
0.7x  ──→  约1.4倍缩小
1.0x  ──→  原始尺度
1.4x  ──→  约1.4倍放大
2.0x  ──→  2倍放大
3.0x  ──→  3倍放大
5.0x  ──→  5倍放大
10.0x ──→  10倍放大
```

**覆盖范围**：100倍（10 ÷ 0.1 = 100）

### 常规模式（7个尺度）

```
0.4x  ──→  2.5倍缩小
0.6x  ──→  约1.7倍缩小
0.8x  ──→  约1.25倍缩小
1.0x  ──→  原始尺度
1.25x ──→  25%放大
1.6x  ──→  60%放大
2.5x  ──→  2.5倍放大
```

**覆盖范围**：6.25倍（2.5 ÷ 0.4 = 6.25）

## 性能影响

| 项目规模 | 图像数量 | 预计分析时间 | 内存占用 |
|---------|---------|-------------|---------|
| 小型 | 2-5张 | 10-30秒 | ~5MB |
| 中型 | 6-15张 | 30秒-2分钟 | ~15MB |
| 大型 | 16-50张 | 2-10分钟 | ~50MB |
| 超大型 | 50+张 | 10分钟+ | ~100MB+ |

## 配置文件位置

所有参数位于：`backend/app/routers_analysis.py`

### 关键代码行号

| 参数 | 行号 | 函数 |
|-----|-----|------|
| 尺度范围 | 242-254 | `_extract_enhanced_features()` |
| 特征点数 | 255 | `_extract_enhanced_features()` |
| 分辨率检测 | 496-523 | `_orb_pairwise_analysis()` |
| Ratio阈值 | 590 | `_orb_pairwise_analysis()` |
| 匹配筛选 | 330-361 | `_adaptive_screenshot_match_filter()` |
| RANSAC参数 | 710-717 | `_orb_pairwise_analysis()` |
| 相似度奖励 | 626-632 | `_orb_pairwise_analysis()` |

## 调优建议

### 场景1：需要更高的识别率

**问题**：部分相似图像未被识别

**解决方案**：
```python
# 放宽ratio threshold
ratio_threshold = 0.90  # ↑ 从0.85

# 放宽RANSAC
ransac_threshold = 20.0  # ↑ 从15.0

# 降低触发阈值
if area_ratio > 1.2:  # ↓ 从1.3
```

### 场景2：减少误匹配

**问题**：不相关的图像被误判为相似

**解决方案**：
```python
# 收紧ratio threshold
ratio_threshold = 0.80  # ↓ 从0.85

# 提高最小匹配
min_matches = 5  # ↑ 从3

# 收紧RANSAC
min_inliers = 3  # ↑ 从2
```

### 场景3：提升性能速度

**问题**：分析时间过长

**解决方案**：
```python
# 减少尺度采样
scales = [0.1, 0.3, 1.0, 3.0, 10.0]  # 5个尺度

# 减少特征点
features_per_scale = 1000  # ↓ 从1500

# 提高触发阈值（减少截图模式使用）
if area_ratio > 2.0:  # ↑ 从1.3
```

## 验证方法

### 1. 检查后端日志

成功检测到极大比例缩放时，会看到：

```bash
⚠️ Resolution mismatch detected: 640x480 vs 6400x4800
   📊 Area ratio: 100.00x, Width ratio: 10.00x, Height ratio: 10.00x
🔍 Screenshot/scale detection enabled - using enhanced matching
🔍 Screenshot mode: using extreme wide-scale range (0.1x - 10x) with 11 scales
```

### 2. 查看特征提取信息

```bash
Image 1: 16500 keypoints extracted (screenshot mode)
Image 2: 16500 keypoints extracted (screenshot mode)
```

### 3. 检查匹配结果

```bash
Images 0-1: 5000 raw matches -> 280 after ratio test (ratio=0.85)
Screenshot match bonus applied: 280 matches, factor: 23.24, final score: 0.892
```

### 4. 前端相似度矩阵

- 相似图像应显示高相似度（>0.7）
- 可以在详情页查看特征点连线

## 常见问题

**Q: 为什么选择11个尺度？**
A: 平衡覆盖范围和性能。使用对数分布可以高效覆盖0.1x-10x的100倍范围。

**Q: 16,500个特征点会不会太多？**
A: 对于现代CPU来说可接受。如果性能有问题，可以降到1000/尺度（11,000总计）。

**Q: ratio=0.85会导致误匹配吗？**
A: 有一定风险，但通过后续的RANSAC几何验证和相似度计算可以过滤大部分误匹配。

**Q: 如何支持更大的比例（如50倍）？**
A: 添加更多采样点：`scales = [0.02, 0.05, 0.1, ..., 10.0, 20.0, 50.0]`

## 更新日志

- **2025-11-17**: 初始配置，支持10倍比例
- **待定**: 根据用户反馈调整参数

---

💡 **提示**：这些参数经过优化以支持极端比例变化。如果你的使用场景不同，可以根据上述建议进行调整。

